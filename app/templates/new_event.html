{% extends 'base.html' %}
{% block content %}
   
    <div class="row-fluid">
      <h3>Pet Tracker: New Event</h3>
      <form action="/events" method="post" class="new-event" aria-label="Create new event form">
        <fieldset>
          <legend>Event Type:</legend>
          <div class="radio-group" role="radiogroup" aria-label="Select event type">
            <label>
              <input type="radio" name="event-type" value="1" id="event-type-food" required aria-label="Food event type" />
              Food
            </label>
            <label>
              <input type="radio" name="event-type" value="2" id="event-type-litter" required aria-label="Litter event type" />
              Litter
            </label>
            <label>
              <input type="radio" name="event-type" value="3" id="event-type-medicine" required aria-label="Medicine event type" />
              Medicine
            </label>
          </div>
        </fieldset>
        <div class="new-event-field">
          <label for="pet">Pet:</label>
          <select name="pet" id="pet" disabled=false aria-label="Select pet for this event">
            <option value="">None</option>
            {% for pet in pets %}
            <option value="{{ pet['id'] }}">{{ pet['name'] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="new-event-field">
          <label for="event-time">Event Date & Time:</label>
          <input type="datetime-local" name="event-time" id="event-time" value="{{ now }}" required aria-label="Event date and time" />
        </div>
        <div id="food-fields" class="hidden">
          <div class="form-row">
            <div class="new-event-field">
              <label for="food-name">Food Name:</label>
              <select name="food-name" id="food-name" aria-label="Select food name or choose to enter custom">
                <option value="">-- Select or enter new --</option>
                {% for food in foods %}
                  <option value="{{ food['name'] }}" data-uuid="{{ food['uuid'] }}">{{ food['name'] }}</option>
                {% endfor %}
                <option value="__other__">Other (enter custom name)</option>
              </select>
              <input type="text" name="food-name-custom" id="food-name-custom" class="hidden" placeholder="Enter food name" aria-label="Enter custom food name"/>
            </div>
            <div class="new-event-field">
              <label for="food-type">Food Type:</label>
              <select name="food-type" id="food-type" aria-label="Select food type">
                <option value="">None</option>
                <option value="wet">Wet</option>
                <option value="dry">Dry</option>
                <option value="treats">Treats</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="new-event-field">
              <label for="food-amount">Food Amount:</label>
              <input type="text" name="food-amount" id="food-amount" aria-label="Enter food amount"/>
            </div>
            <div class="new-event-field">
              <label for="food-unit">Food Unit:</label>
              <select name="food-unit" id="food-unit" aria-label="Select food unit">
                <option value="">None</option>
                <option value="grams">Grams</option>
                <option value="cups">Cups</option>
                <option value="oz">Ounces</option>
                <option value="cans">Cans</option>
              </select>
            </div>
          </div>
          <div class="new-event-field">
            <label for="food-calories">Food Calories:</label>
            <input type="text" name="food-calories" id="food-calories" aria-label="Enter food calories"/>
          </div>
          <div class="new-event-field">
            <label class="checkbox-label">
              <input type="checkbox" name="save-food" id="save-food" value="1" aria-label="Save this food for future use"/>
              Save Food
            </label>
          </div>
        </div>
        <div id="medicine-fields" class="hidden">
          <div class="new-event-field">
            <label for="medicine-name">Medicine Name:</label>
            <input type="text" name="medicine-name" id="medicine-name" aria-label="Enter medicine name"/>
          </div>
          <div class="new-event-field">
            <label for="medicine-dose">Medicine Dose:</label>
            <input type="text" name="medicine-dose" id="medicine-dose" aria-label="Enter medicine dose"/>
          </div>
        </div>
        <button type="submit" aria-label="Create new event">Create</button>
      </form>
    </div>

    <script>
      // Store food data for autofill
      const foodsData = {
        {% if foods %}
        {% for food in foods %}
        "{{ food['name']|replace('"', '\\"') }}": {
          "type": "{{ food['type'] }}",
          "serving_size": {{ food['serving_size'] }},
          "unit": "{{ food['unit'] }}",
          "calories": {{ food['calories'] }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
      };

      // Get all event type radio buttons
      const eventTypeRadios = document.querySelectorAll('input[name="event-type"]');
      const petSelect = document.getElementById('pet');
      const foodFields = document.getElementById('food-fields');
      const medicineFields = document.getElementById('medicine-fields');
      const foodNameSelect = document.getElementById('food-name');
      const foodNameCustom = document.getElementById('food-name-custom');
      const foodTypeSelect = document.getElementById('food-type');
      const foodAmountInput = document.getElementById('food-amount');
      const foodUnitSelect = document.getElementById('food-unit');
      const foodCaloriesInput = document.getElementById('food-calories');

      // Track currently selected food for calorie calculation
      let currentFoodData = null;

      // Function to get the actual food name (from select or custom input)
      function getFoodName() {
        if (foodNameSelect.value === '__other__') {
          return foodNameCustom.value.trim();
        }
        return foodNameSelect.value.trim();
      }

      // Function to show/hide custom food name input
      function toggleCustomFoodInput() {
        if (foodNameSelect.value === '__other__') {
          foodNameCustom.classList.remove('hidden');
          foodNameCustom.required = true;
          foodNameSelect.removeAttribute('name'); // Remove name so custom input is submitted
          foodNameCustom.setAttribute('name', 'food-name');
        } else {
          foodNameCustom.classList.add('hidden');
          foodNameCustom.required = false;
          foodNameCustom.removeAttribute('name');
          foodNameSelect.setAttribute('name', 'food-name');
        }
      }

      // Function to autofill food fields when an existing food is selected
      function autofillFoodFields() {
        toggleCustomFoodInput();
        const foodName = getFoodName();
        foodUnitSelect.disabled = false;
        
        if (foodName && foodsData[foodName]) {
          const food = foodsData[foodName];
          currentFoodData = food; // Store for calorie calculation
          foodTypeSelect.value = food.type;
          foodAmountInput.value = food.serving_size;
          foodUnitSelect.value = food.unit;
          foodUnitSelect.disabled = true;
          foodCaloriesInput.value = food.calories;
        } else {
          currentFoodData = null;
          // If switching to "Other" or selecting empty, clear autofilled fields
          if (foodNameSelect.value === '__other__' || foodNameSelect.value === '') {
            // Don't clear if user is typing in custom field and it might match
            if (foodNameSelect.value === '__other__' && foodNameCustom.value.trim() === '') {
              foodTypeSelect.value = '';
              foodAmountInput.value = '';
              foodUnitSelect.value = '';
              foodCaloriesInput.value = '';
            }
          } else if (foodNameSelect.value !== '') {
            // Selected a food from dropdown but it's not in foodsData (shouldn't happen, but handle it)
            foodTypeSelect.value = '';
            foodAmountInput.value = '';
            foodUnitSelect.value = '';
            foodCaloriesInput.value = '';
          }
        }
      }

      // Function to calculate calories based on amount
      function calculateCalories() {
        if (!currentFoodData) return;
        
        const amount = parseFloat(foodAmountInput.value);
        if (isNaN(amount) || amount <= 0) {
          return;
        }

        const servingSize = currentFoodData.serving_size;
        const caloriesPerServing = currentFoodData.calories;
        
        // Calculate: (amount / serving_size) * calories_per_serving
        const calculatedCalories = (amount / servingSize) * caloriesPerServing;
        foodCaloriesInput.value = Math.round(calculatedCalories);
      }

      // Listen for changes on food name select
      foodNameSelect.addEventListener('change', autofillFoodFields);
      // Listen for input on custom food name
      foodNameCustom.addEventListener('input', autofillFoodFields);
      // Listen for changes on food amount to recalculate calories
      foodAmountInput.addEventListener('input', calculateCalories);
      foodAmountInput.addEventListener('change', calculateCalories);

      // Function to toggle food fields visibility
      function toggleFields() {
        const foodSelected = document.getElementById('event-type-food').checked;
        if (foodSelected) {
          foodFields.classList.remove('hidden');
        } else {
          foodFields.classList.add('hidden');
        }
        const medicineSelected = document.getElementById('event-type-medicine').checked;
        if (medicineSelected) {
          medicineFields.classList.remove('hidden');
        } else {
          medicineFields.classList.add('hidden');
        }
      }

      // enable/disable pet select based on event type
      function togglePetSelect() {
        const litterSelected = document.getElementById('event-type-litter').checked;
        petSelect.value = litterSelected ? 0 : petSelect.value;
        petSelect.disabled = litterSelected;
      }

      // Add event listeners to all radio buttons
      eventTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleFields);
        radio.addEventListener('change', togglePetSelect);
      });

      // Check initial state on page load
      togglePetSelect();
      toggleFields();
      toggleCustomFoodInput();
    </script>

{% endblock %}