{% extends 'base.html' %}
{% block content %}

<div class="row-fluid">
  <div class="events-header">
    <h3>{{ household_name }}</h3>
    <div class="hamburger-menu">
      <div class="hamburger-icon" onclick="toggleMenu()" aria-label="Open menu">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="hamburger-menu-dropdown" id="menuDropdown">
        <form action="/logout" method="get">
          <button type="submit" aria-label="Log out">Log Out</button>
        </form>
        <button type="button" aria-label="Placeholder option">[Placeholder Option]</button>
      </div>
    </div>
  </div>

  <div class="pets-section">
    <div class="pets-container">
      {% for pet in pets %}
        <div class="pet-item">
          {% if pet['photo_addr'] %}
            <img src="/{{ pet['photo_addr'] }}" alt="{{ pet['name'] }}" title="{{ pet['name'] }}" />
          {% else %}
            <div class="pet-placeholder">
              <span>üê±</span>
            </div>
          {% endif %}
          <span class="pet-name">{{ pet['name'] }}</span>
        </div>
      {% endfor %}
    </div>
    <a href="/events" class="back-button" aria-label="Go back to events">
      <span>‚Üê</span>
    </a>
  </div>

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <div class="days-container" id="daysContainer">
    {% for day in days %}
      <div class="day-section">
        <div class="day-header">{{ day['date'] }}</div>
        <table class="day-table" role="table" aria-label="Events for {{ day['date'] }}">
          <thead>
            <tr>
              <th scope="col">Type</th>
              <th scope="col">Pet</th>
              <th scope="col">Meta</th>
            </tr>
          </thead>
          <tbody>
            {% for type, event in day['events'].items() %}
              {% for pet_key, value in event.items() %}
                {% set pet_parts = pet_key.split('|||') %}
                {% set pet_name = pet_parts[0] if pet_parts|length > 0 else '' %}
                {% set pet_icon = pet_parts[1] if pet_parts|length > 1 else '' %}
                {% if type == 'Medicine' and value is iterable and value is not string %}
                  {% for medicine in value %}
                    <tr data-event-type="{{ type }}">
                      <td>
                        <img src="/assets/{{ type }}Icon.svg" alt="{{ type }}" title="{{ type }}" aria-label="{{ type }} event type icon" class="event-icon" />
                      </td>
                      <td>
                        {%if pet_name %}
                          <img src="/{{ pet_icon }}" alt="{{ pet_name }}" title="{{ pet_name }}" aria-label="{{ pet_name }} pet icon" class="event-icon" />
                        {% endif %}
                      </td>
                      <td>
                        {% if medicine.name %}
                          {{ medicine.name }}{% if medicine.dose %}, {{ medicine.dose }}{% endif %}
                        {% else %}
                          Medicine
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr data-event-type="{{ type }}">
                    <td>
                      <img src="/assets/{{ type }}Icon.svg" alt="{{ type }}" title="{{ type }}" aria-label="{{ type }} event type icon" class="event-icon" />
                    </td>
                    <td>
                      {%if pet_name %}
                        <img src="/{{ pet_icon }}" alt="{{ pet_name }}" title="{{ pet_name }}" aria-label="{{ pet_name }} pet icon" class="event-icon" />
                      {% endif %}
                    </td>
                    <td>
                      {%if type == 'Food' %}
                        {{ value }} calories
                      {% elif type == 'Litter' %}
                        {{ value }} times
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

  <div class="loading-indicator" id="loadingIndicator">Loading more days...</div>
  <div class="no-more-days" id="noMoreDays">No more days with events</div>
</div>

<script>
  function toggleMenu() {
    const dropdown = document.getElementById('menuDropdown');
    dropdown.classList.toggle('show');
  }

  // Close menu when clicking outside
  document.addEventListener('click', function(event) {
    const menu = document.querySelector('.hamburger-menu');
    const dropdown = document.getElementById('menuDropdown');
    if (menu && dropdown && !menu.contains(event.target)) {
      dropdown.classList.remove('show');
    }
  });

  // Infinite scroll implementation
  let isLoading = false;
  let hasMoreDays = true;
  let lastLoadedDate = null;

  // Get the last date from the initial loaded days
  const initialDays = {{ days | tojson }};
  if (initialDays.length > 0) {
    lastLoadedDate = initialDays[initialDays.length - 1]['date_iso'];
  }

  function loadMoreDays() {
    if (isLoading || !hasMoreDays) {
      return;
    }

    isLoading = true;
    document.getElementById('loadingIndicator').classList.add('show');
    document.getElementById('noMoreDays').classList.remove('show');

    // Calculate the start date (one day before the last loaded date)
    let startDate = lastLoadedDate;
    if (startDate) {
      const date = new Date(startDate);
      date.setDate(date.getDate() - 1);
      startDate = date.toISOString().split('T')[0];
    } else {
      // If no last date, start from today
      const today = new Date();
      today.setDate(today.getDate() - 1);
      startDate = today.toISOString().split('T')[0];
    }

    fetch(`/api/events/days?start_date=${startDate}&limit=5`)
      .then(response => response.json())
      .then(data => {
        isLoading = false;
        document.getElementById('loadingIndicator').classList.remove('show');

        if (data.error) {
          console.error('Error loading days:', data.error);
          hasMoreDays = false;
          return;
        }

        const newDays = data.days || [];
        
        if (newDays.length === 0) {
          hasMoreDays = false;
          document.getElementById('noMoreDays').classList.add('show');
          return;
        }

        // Append new days to the container
        const container = document.getElementById('daysContainer');
        newDays.forEach(day => {
          const daySection = createDaySection(day);
          container.appendChild(daySection);
        });

        // Update last loaded date
        if (newDays.length > 0) {
          lastLoadedDate = newDays[newDays.length - 1]['date_iso'];
        }

        // If we got fewer days than requested, there are no more
        if (newDays.length < 5) {
          hasMoreDays = false;
          document.getElementById('noMoreDays').classList.add('show');
        }
      })
      .catch(error => {
        console.error('Error loading days:', error);
        isLoading = false;
        document.getElementById('loadingIndicator').classList.remove('show');
        hasMoreDays = false;
      });
  }

  function createDaySection(day) {
    const daySection = document.createElement('div');
    daySection.className = 'day-section';

    const dayHeader = document.createElement('div');
    dayHeader.className = 'day-header';
    dayHeader.textContent = day.date;
    daySection.appendChild(dayHeader);

    const table = document.createElement('table');
    table.className = 'day-table';
    table.setAttribute('role', 'table');
    table.setAttribute('aria-label', `Events for ${day.date}`);

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['Type', 'Pet', 'Meta'].forEach(headerText => {
      const th = document.createElement('th');
      th.setAttribute('scope', 'col');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    
    // Iterate through event types
    Object.entries(day.events).forEach(([type, event]) => {
      Object.entries(event).forEach(([petKey, value]) => {
        // Parse pet key: "pet_name|||pet_icon"
        const petParts = petKey.split('|||');
        const petName = petParts[0] || '';
        const petIcon = petParts[1] || '';

        // For Medicine events, create a separate row for each medicine
        if (type === 'Medicine' && Array.isArray(value)) {
          value.forEach(medicine => {
            const row = document.createElement('tr');
            row.setAttribute('data-event-type', type);

            // Type cell
            const typeCell = document.createElement('td');
            const typeImg = document.createElement('img');
            typeImg.src = `/assets/${type}Icon.svg`;
            typeImg.alt = type;
            typeImg.title = type;
            typeImg.setAttribute('aria-label', `${type} event type icon`);
            typeImg.className = 'event-icon';
            typeCell.appendChild(typeImg);
            row.appendChild(typeCell);

            // Pet cell
            const petCell = document.createElement('td');
            if (petName && petIcon) {
              const petImg = document.createElement('img');
              petImg.src = `/${petIcon}`;
              petImg.alt = petName;
              petImg.title = petName;
              petImg.setAttribute('aria-label', `${petName} pet icon`);
              petImg.className = 'event-icon';
              petCell.appendChild(petImg);
            }
            row.appendChild(petCell);

            // Meta cell
            const metaCell = document.createElement('td');
            let medicineText = medicine.name || 'Medicine';
            if (medicine.dose) {
              medicineText += `, ${medicine.dose}`;
            }
            metaCell.textContent = medicineText;
            row.appendChild(metaCell);

            tbody.appendChild(row);
          });
        } else {
          // For Food and Litter events, create a single row
          const row = document.createElement('tr');
          row.setAttribute('data-event-type', type);

          // Type cell
          const typeCell = document.createElement('td');
          const typeImg = document.createElement('img');
          typeImg.src = `/assets/${type}Icon.svg`;
          typeImg.alt = type;
          typeImg.title = type;
          typeImg.setAttribute('aria-label', `${type} event type icon`);
          typeImg.className = 'event-icon';
          typeCell.appendChild(typeImg);
          row.appendChild(typeCell);

          // Pet cell
          const petCell = document.createElement('td');
          if (petName && petIcon) {
            const petImg = document.createElement('img');
            petImg.src = `/${petIcon}`;
            petImg.alt = petName;
            petImg.title = petName;
            petImg.setAttribute('aria-label', `${petName} pet icon`);
            petImg.className = 'event-icon';
            petCell.appendChild(petImg);
          }
          row.appendChild(petCell);

          // Meta cell
          const metaCell = document.createElement('td');
          if (type === 'Food') {
            metaCell.textContent = `${value} calories`;
          } else if (type === 'Litter') {
            metaCell.textContent = `${value} times`;
          }
          row.appendChild(metaCell);

          tbody.appendChild(row);
        }
      });
    });

    table.appendChild(tbody);
    daySection.appendChild(table);

    return daySection;
  }

  // Set up infinite scroll
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      // Check if user is near bottom of page
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // Load more when within 200px of bottom
      if (documentHeight - (scrollTop + windowHeight) < 200) {
        loadMoreDays();
      }
    }, 100);
  });

  // Also try to load more on initial page load if content is short
  window.addEventListener('load', () => {
    setTimeout(() => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      if (documentHeight < windowHeight * 1.5) {
        loadMoreDays();
      }
    }, 500);
  });
</script>

{% endblock %}
